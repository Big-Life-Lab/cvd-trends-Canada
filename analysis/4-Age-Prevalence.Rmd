---
title: "4-Age-Prevalence"
author: "Kitty Chen"
date: "19/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Survey design and function
```{r}
library(srvyr)
library(dplyr)
library(tidyr)

# Design (all)
svy_design <- as_survey_design(.data=harmonized_combined, weights="WTS_M")

# Design (male)
combined_male <- harmonized_combined %>% filter(DHH_SEX == 1)
svy_design_male <- as_survey_design(.data=combined_male, weights="WTS_M")

#Design (female)
combined_female <- harmonized_combined %>% filter(DHH_SEX == 2)
svy_design_female <- as_survey_design(.data=combined_female, weights="WTS_M")

# Prevalence
prev <- function(design, sum_var, filter_value){
  
  # Prevalence 
  table <- design %>%
    group_by(year,Age_Group, {{sum_var}}) %>%
    summarise(proportion = survey_mean()*100) %>%
    filter({{sum_var}} == filter_value) %>%
    select(-proportion_se, -{{sum_var}})
  
  # Generate p-value from regression
  pval <- summary(lm(proportion ~ Age_Group, data = table))
  pval_col <-as.numeric(pval$coefficients[,"Pr(>|t|)"])
  
  # Complete table with p-value
  table <- table %>%
    spread(year, proportion) %>%
    mutate(diff = ((`2017` - `2001`) / `2001`*100))
  table$p_value <- pval_col
  
  return(table)
}
```

## Both sex

```{r Hypertension}
ht_t1 <-prev(svy_design, CCC_071, 1)
ht_t1 
```

```{r Diabetes}
db_t1 <-prev(svy_design, CCC_101, 1)
db_t1
```

```{r Blood cholesterol}
bc_t1 <-prev(svy_design, CCC_075, 1)
bc_t1
```

```{r Obesity}
bmi_t1 <-prev(svy_design, HWTGBMI_der_cat4, 4)
bmi_t1
```

```{r Physical inactivity}
mets_t1 <- prev(svy_design, activity, "Inactive")
mets_t1
```

```{r Smoking}
smoke_t1 <- prev(svy_design, SMKDSTY_cat3, 1)
smoke_t1
```

```{r Drinking}
alc_t1 <-prev(svy_design, Alcohol, 4)
alc_t1
```

```{r Full table}
# Tb_t1 <- gtsummary::tbl_stack(list(alc_tb, bmi_tb,db_tb,ht_tb, mets_tb,smoke_tb))

```

## Male

```{r Hypertension}
ht_t1 <-prev(svy_design_male, CCC_071, 1)
ht_t1 
```

```{r Diabetes}
db_t1 <-prev(svy_design_male, CCC_101, 1)
db_t1
```

```{r Blood cholesterol}
bc_t1 <-prev(svy_design_male, CCC_075, 1)
bc_t1
```

```{r Obesity}
bmi_t1 <-prev(svy_design_male, HWTGBMI_der_cat4, 4)
bmi_t1
```

```{r Physical inactivity}
mets_t1 <- prev(svy_design_male, activity, "Inactive")
mets_t1
```

```{r Smoking}
smoke_t1 <- prev(svy_design_male, SMKDSTY_cat3, 1)
smoke_t1
```

```{r Drinking}
alc_t1 <-prev(svy_design_male, Alcohol, 4)
alc_t1
```

```{r Full table}
# Tb_t1 <- gtsummary::tbl_stack(list(alc_tb, bmi_tb,db_tb,ht_tb, mets_tb,smoke_tb))

```

## Female

```{r Hypertension}
ht_t1 <-prev(svy_design_female, CCC_071, 1)
ht_t1 
```

```{r Diabetes}
db_t1 <-prev(svy_design_female, CCC_101, 1)
db_t1
```

```{r Blood cholesterol}
bc_t1 <-prev(svy_design_female, CCC_075, 1)
bc_t1
```

```{r Obesity}
bmi_t1 <-prev(svy_design_female, HWTGBMI_der_cat4, 4)
bmi_t1
```

```{r Physical inactivity}
mets_t1 <- prev(svy_design_female, activity, "Inactive")
mets_t1
```

```{r Smoking}
smoke_t1 <- prev(svy_design_female, SMKDSTY_cat3, 1)
smoke_t1
```

```{r Drinking}
alc_t1 <-prev(svy_design_female, Alcohol, 4)
alc_t1
```

```{r Full table}
# Tb_t1 <- gtsummary::tbl_stack(list(alc_tb, bmi_tb,db_tb,ht_tb, mets_tb,smoke_tb))

```


