---
title: "Prevalence by province"
author: "Kitty Chen"
date: "26/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Survey design and function
```{r}
library(srvyr)
library(dplyr)
library(tidyr)

# Design
svy_design <- as_survey_design(.data=harmonized_combined, weights="WTS_M")

# Prevalence for provinces and territories
prev_pt <- function(design, sum_var, filter_value){
  
  # Prevalence 
  table <- design %>%
    group_by(year,Province, {{sum_var}}) %>%
    summarise(proportion = survey_mean()*100) %>%
    filter({{sum_var}} == filter_value) %>%
    select(-proportion_se, -{{sum_var}})
  
  # Generate p-value from regression
  pval <- summary(lm(proportion ~ Province, data = table))
  pval_col <-as.numeric(pval$coefficients[,"Pr(>|t|)"])
  
  # Complete table with p-value
  table <- table %>%
    spread(year, proportion) %>%
    mutate(diff = ((`2017` - `2001`) / `2001`*100))
  table$p_value <- pval_col
  
  return(table)
}
```


```{r Hypertension}
ht_pt <-prev_pt(svy_design, CCC_071, 1)
ht_pt 
```

```{r Diabetes}
db_pt <-prev_pt(svy_design, CCC_101, 1)
db_pt
```

```{r Blood cholesterol}
bc_pt <-prev_pt(svy_design, CCC_075, 1)
bc_pt
```

```{r Obesity}
bmi_pt <-prev_pt(svy_design, HWTGBMI_der_cat4, 4)
bmi_pt
```

```{r Physical inactivity}
mets_pt <- prev_pt(svy_design, activity, "Inactive")
mets_pt
```

```{r Smoking}
smoke_pt <- prev_pt(svy_design, SMKDSTY_cat3, 1)
smoke_pt
```

```{r Drinking}
alc_pt <-prev_pt(svy_design, Alcohol, 4)
alc_pt
```

```{r Full table}
# Tb_pt <- gtsummary::tbl_stack(list(alc_tb, bmi_tb,db_tb,ht_tb, mets_tb,smoke_tb))

```
